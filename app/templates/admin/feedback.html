{% extends "admin/base.html" %}

{% block title %}反馈管理{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3">反馈管理</h1>
    <form class="d-flex" method="get">
        <select class="form-select me-2" name="status">
            <option value="">全部状态</option>
            <option value="new" {{ 'selected' if status_filter=='new' else '' }}>未处理</option>
            <option value="in_progress" {{ 'selected' if status_filter=='in_progress' else '' }}>处理中</option>
            <option value="resolved" {{ 'selected' if status_filter=='resolved' else '' }}>已解决</option>
            <option value="archived" {{ 'selected' if status_filter=='archived' else '' }}>已归档</option>
        </select>
        <button class="btn btn-outline-primary" type="submit">筛选</button>
    </form>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="ms-3">
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} py-1 px-2 mb-1">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}
</div>

{% if feedback %}
<div class="row g-3">
    {% for item in feedback %}
    <div class="col-12 col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="text-muted small">
                        {{ item.submitted_at }}
                        {% if item.upload_status == 'pending_images' %}
                            <span class="badge bg-warning text-dark ms-2">
                                <i class="bi bi-cloud-arrow-up"></i> 图片上传中... ({{ item.uploaded_images }}/{{ item.total_images }})
                            </span>
                        {% endif %}
                    </div>
                    <span class="badge {% if item.status=='new' %}bg-secondary{% elif item.status=='in_progress' %}bg-info{% elif item.status=='resolved' %}bg-success{% else %}bg-dark{% endif %}">{{ item.status or 'new' }}</span>
                </div>
                <div class="mb-2">
                    <div class="fw-bold">来自：{{ item.user.username or '未设置用户名' }}</div>
                    <div class="text-muted small"><i class="bi bi-envelope me-1"></i> {{ item.user.email }}</div>
                </div>
                <p class="mb-2" style="white-space: pre-wrap;">{{ item.description }}</p>
                {% if item.image_paths and item.image_paths|length > 0 %}
                <div class="d-flex flex-wrap gap-2 mb-2">
                    {% for img_path in item.image_paths %}
                    {% set img_url = img_path if img_path.startswith('http') else url_for('static', filename=img_path) %}
                    <a href="{{ img_url }}" target="_blank">
                        <img src="{{ img_url }}" alt="反馈图片" style="max-width: 120px; max-height: 120px; border-radius: 12px;"/>
                    </a>
                    {% endfor %}
                </div>
                {% endif %}

                {% if item.replies %}
                <hr>
                <div class="mt-2">
                    <h6 class="card-subtitle mb-2 text-muted">管理员回复</h6>
                    {% for reply in item.replies %}
                    <div class="mb-2 p-2 bg-light rounded">
                        <p class="mb-1 small">{{ reply.message }}</p>
                        <div class="text-end text-muted small">
                            - {{ reply.admin_name }} at {{ reply.timestamp.split('T')[0] }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-transparent">
                <form class="d-inline" method="post" action="{{ url_for('payment_bp.admin_feedback_update_status', feedback_id=item.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="status" value="new"/>
                    <button type="submit" class="btn btn-sm btn-outline-secondary">未处理</button>
                </form>
                <form class="d-inline ms-1" method="post" action="{{ url_for('payment_bp.admin_feedback_update_status', feedback_id=item.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="status" value="in_progress"/>
                    <button type="submit" class="btn btn-sm btn-outline-info">处理中</button>
                </form>
                <form class="d-inline ms-1" method="post" action="{{ url_for('payment_bp.admin_feedback_update_status', feedback_id=item.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="status" value="resolved"/>
                    <button type="submit" class="btn btn-sm btn-outline-success">已解决</button>
                </form>
                <form class="d-inline ms-1" method="post" action="{{ url_for('payment_bp.admin_feedback_update_status', feedback_id=item.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="status" value="archived"/>
                    <button type="submit" class="btn btn-sm btn-outline-dark">归档</button>
                </form>
                <button type="button" class="btn btn-sm btn-outline-danger ms-1 btn-delete-feedback" data-feedback-id="{{ item.id }}">删除</button>
                <form class="d-inline float-end" method="post" action="{{ url_for('payment_bp.admin_feedback_reply', feedback_id=item.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="input-group input-group-sm" style="max-width: 420px;">
                        <input type="text" name="reply" class="form-control" placeholder="输入要发送给用户的消息...">
                        <button class="btn btn-primary" type="submit"><i class="bi bi-send"></i> 发送</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-light">暂无反馈</div>
{% endif %}

{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    document.querySelectorAll('.btn-delete-feedback').forEach(button => {
        button.addEventListener('click', function() {
            const feedbackId = this.dataset.feedbackId;
            if (confirm('确定要永久删除这条反馈吗？')) {
                fetch(`/admin/feedback/${feedbackId}/delete`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('服务器响应错误: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Find the card and remove it
                        this.closest('.col-12').remove();
                        // You can add a more sophisticated notification here if you like
                        alert('反馈已删除。');
                    } else {
                        alert('删除失败: ' + (data.error || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除过程中发生网络错误。');
                });
            }
        });
    });
});
</script>
{% endblock %}



