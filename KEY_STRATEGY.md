# API密钥管理策略与未来规划 (BYOK模式)

## 1. 决议与核心思想

经过对项目现状的全面分析和未来发展的考量，我们决定采纳 **"自带密钥（Bring Your Own Key - BYOK）"** 作为当前阶段API密钥管理的核心策略。

**核心思想**:
- **用户隔离**: 每个用户提交的API Key **仅供该用户自己** 的请求使用。系统绝不使用用户A的Key去处理用户B的请求。
- **价值交换**: 用户通过提供自己的Key，可以换取更低的服务使用成本（例如，每次查询消耗更少的积分）或解锁高级功能。这是激励用户提供Key的主要方式。
- **系统托底**: 对于未提供自己Key的用户，系统将使用平台自身的全局API Key来提供服务，但这部分服务将按标准价格收费。
- **透明与信任**: 此模式完全透明，规避了潜在的法律合规风险和用户信任问题，是项目长期稳定发展的基石。

## 2. 对当前代码实现的分析

通过对 `database`, `routes`, 和 `services` 模块的扫描，我们发现：

- **现有架构**: 系统目前是一个**混合实现**。它已经具备了BYOK的核心逻辑：`APIKeyManager` 在处理请求时，会优先尝试获取用户自己的Key (`get_next_key(user_id)`)，如果找不到，则回退使用系统的默认Key。
- **冗余设计**: 当前系统存在为"共享池"模式设计的、但未在服务中启用的复杂功能。
    - **`api_keys` 数据表**: 包含 `share_count`, `earned_points` 等字段，这些是为共享模式准备的。
    - **`is_key_registered_by_another_user` 检查**: 在用户提交Key时，会检查该Key是否已被其他用户注册，这是共享池防止重复的逻辑。
    - **双重写入**: 用户提交的Key被同时写入 `api_keys` 表和 `users` 表，造成了数据冗余。

## 3. 下一步行动计划 (Action Plan)

为了使代码架构与我们的BYOK策略完全对齐，并为未来可能的扩展做好准备，建议进行以下调整：

### 阶段一：架构简化与对齐 (立即执行)

1.  **明确数据主源**:
    - **确立 `api_keys` 表为唯一可信源**: 所有用户自定义的API Key都只存储在该表中。
    - **废弃 `users` 表中的Key字段**: 停止向 `users` 表（`amap_key`, `baidu_key` 等）写入任何Key。后续版本可以考虑通过数据库迁移移除这些字段。
    - **改造 `APIKeyManager`**: 确保 `APIKeyManager` 只从 `api_keys` 表中为特定用户获取Key，而不是依赖任何其他来源。

2.  **精简"共享池"相关逻辑**:
    - **移除 `is_key_registered_by_another_user` 检查**: 在纯BYOK模式下，我们不关心一个Key是否被多个用户使用（因为他们各自承担自己Key的额度消耗）。移除此检查可以简化逻辑，并让家庭成员或团队成员可以使用同一个商业Key。
    - **调整 `api_keys` 表**:
        - `share_count`, `earned_points` 等字段暂时可以保留，但业务逻辑中不应再使用。将它们视为"为未来预留"。
        - 或者，可以进行一次数据库迁移，将这些暂时无用的字段移除，让表结构更清晰。

3.  **调整激励机制**:
    - **更改积分奖励**: 奖励应与"提供Key"这个行为本身绑定，而不是"分享"。当用户成功添加一个有效的Key后，可以给予一次性积分奖励。
    - **实现成本折扣**: 修改积分扣除逻辑。在发起API请求时，判断本次请求是使用了用户自己的Key还是系统Key。如果使用了用户Key，则扣除较少的积分；如果使用系统Key，则扣除标准积分。这是BYOK模式的核心激励。

### 阶段二：探索共享池模式 (未来规划)

当平台发展到一定规模，拥有大量信任我们的用户后，可以考虑重新引入"共享池"作为一项**可选的、透明的**高级功能。

- **创建"社区贡献计划"**: 用户必须**主动选择加入**，并明确同意共享其Key的闲置额度。
- **设计贡献回报**: 作为回报，可以设计一套按"贡献量"（Key被社区使用的次数）计算的、持续性的积分奖励机制。
- **激活预留字段**: 届时，可以重新启用 `api_keys` 表中的 `share_count`, `earned_points` 等字段，并恢复Key的唯一性检查。
- **建立Key调度系统**: 需要一个更智能的 `APIKeyManager`，能够监控共享池中所有Key的状态和用量，并进行公平、高效的轮询调度。

此文档作为项目后续迭代的指导方针，确保所有开发者对API Key的管理策略有一致的理解。 