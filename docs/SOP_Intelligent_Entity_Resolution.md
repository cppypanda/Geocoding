### 智能实体解析与分析标准作业流程 (SOP) - V2.0

**版本: 2.0**
**最后更新日期: 2024-07-27**

#### 1. 核心目标与设计哲学

本文档旨在详细说明一套全新的、基于大语言模型（LLM）的智能实体解析与分析流程。此SOP涵盖两大核心功能：
1.  **A. 批量语义预分析**: 在地理编码任务开始时，对整批地址进行自动化的语义理解，以智能命名任务并为后续处理建立实体类型的认知基础。
2.  **B. 交互式实体解析**: 在校准阶段，为用户提供强大的交互式工具，以解决单个传统POI搜索引擎难以处理的、复杂的地理实体的精确定位问题。

**核心原则：**
*   **从检索到推理**: 将地理编码从简单的“名称到坐标”的关键词匹配，升级为“理解-推理-验证”的认知过程。
*   **鲁棒性优先**: 流程设计旨在应对POI数据缺失或不准确的现实情况，通过外部信息源动态增强定位能力。
*   **可解释性**: 不仅提供一个坐标点，更要向用户展示得出该结果的逻辑链条，建立用户信任。
*   **自动化与人机结合**: 通过前置的自动化分析减少重复工作，同时提供强大的交互工具，实现效率与精度的最佳平衡。

---

### **Part A: 批量语义预分析**

此流程是所有地理编码任务（“普通”或“智能”）启动后的一个并行的、自动化的增强步骤。

#### A.1 功能目标
*   **智能任务命名 (非阻塞式)**: 在不中断核心地理编码流程的前提下，根据用户输入的地址列表，自动生成一个富有语义的、可读的任务/名录名称（如“XX省农业文化遗产名录”）。此名称将自动填充到结果区，供用户在导出或保存时确认，以提升流程流畅性。
*   **实体空间尺度预判**: 识别列表中的复杂地理实体，并预先判断其大致的空间尺度（如“村镇级”、“区县级”），为后续的地理编码置信度评估提供关键的语义依据。

#### A.2 执行流程
1.  **触发与并行处理**:
    *   用户点击“普通地理编码”或“一键智能编码”按钮。
    *   **主流程**: 地理编码任务**立即开始**，前端界面按照`UI_Flow.md`的定义，平滑滚动至结果区，以提供即时反馈。
    *   **并行后台任务**: 本“批量语义预分析”流程与主流程**并行、异步**执行，不阻塞UI或核心计算。
2.  **输入与智能抽样**:
    *   后台任务获取经过清洗后的完整地址列表。
    *   **抽样规则**:
        *   若地址总数 > 10，则随机抽取10条地址作为样本。
        *   若地址总数 ≤ 10，则使用全部地址。
        *   此举旨在保证主题代表性的同时，大幅降低大批量任务的分析成本和延迟。
3.  **LLM处理 (条件性知识增强链条)**: 此步骤被设计成一个智能的、多阶段的链式调用，以实现成本和质量的平衡。
    *   **3.1 初步分析与自我评估 (Fast Path)**:
        *   系统将抽样后的地址列表首次提交给LLM。
        *   **关键指令**: 指令要求LLM进行初步分析，并以结构化JSON格式返回其自我评估结果。
            > "请分析以下地址列表，并以JSON格式返回结果。结果需包含三个字段: 1. `theme_name`: (string) 你根据现有知识得出的任务主题名称。 2. `search_needed`: (boolean) 你是否需要通过网络搜索来更准确地理解这些地址的共同主题和空间尺度特性？如果你对实体类型（如‘桑基鱼塘系统’）感到陌生或不确定，请设为 `true`。 3. `search_query`: (string, 可选) 如果 `search_needed` 为 `true`，请提供一个最优的、用于网络搜索的关键词。"
        *   程序接收此JSON响应。

    *   **3.2 条件性网络搜索**:
        *   程序检查响应中的 `search_needed` 字段。
        *   若为 `false`，则LLM对任务有足够信心，知识增强链条终止。系统进入步骤4，直接使用 `theme_name` 的结果。
        *   若为 `true`，则程序提取 `search_query` 字段的内容（如“农业文化遗产 保护范围”），并自动调用网络搜索引擎执行搜索。

    *   **3.3 最终综合分析 (Slow Path)**:
        *   程序将网络搜索返回的关键信息摘要与原始的地址列表进行整合。
        *   系统将这个“增强后”的信息包**第二次**提交给LLM。
        *   **最终指令**:
            > "请结合以下的原始地址列表和网络搜索结果，为这个任务生成一个最准确的主题名称，并分析这些地理实体的空间尺度特点（以结构化数据返回）。"
        *   LLM返回最终的、经过知识增强的分析结果。

4.  **结果集成与UI更新 (后置确认)**:
    *   **任务名称**: LLM最终返回的任务名称，通过一个API回调或WebSocket消息，被**自动填充**到结果表格右上角（“显示全部”按钮左侧）的一个**可编辑的任务名称区域**。用户可随时**单击该名称进行修改**。这个最终确定的名称，将作为**默认值**，在用户点击“导出文件”或“保存到账户”时被使用。
    *   **实体元数据**: LLM最终分析出的实体类型和空间尺度元数据被缓存，并在后续的“核心瀑布流决策逻辑”（见 `SOP_Multi_Source_Geocoding.md`）中被置信度计算模型（特别是A-类模型）调用，以进行更精准的评分。

---

### **Part B: 交互式实体解析**

此功能作为“地址查找工具”中的高级模块提供，是Part A的补充和深化，专注于解决单个、具体、疑难的实体定位问题。

#### B.1 功能入口与触发机制

*   **功能定位**: “地址查找工具区” -> “智能地址情报分析面板”。
*   **界面元素**:
    *   智能搜索输入框 (`#searchInput`)。
    *   智能搜索表单/按钮 (`#smartSearchForm`)。
*   **触发流程**:
    1.  用户在“逐条校准区”遇到难以定位的地址。
    2.  用户点击“地址查找工具”按钮，进入地址查找面板。
    3.  用户将需要解析的复杂实体名称（如“邵阳武冈市穿城河历史文化街区”）输入到“智能搜索输入框”中，并点击搜索。
    4.  系统启动本SOP中定义的交互式实体解析流程。

---

#### B.2 第一阶段：初始POI检索与启发式评估

此阶段的目标是快速尝试传统的POI搜索方法，并利用LLM进行初步的“质检”，以判断是否需要启动成本更高的第二阶段流程。

*   **执行流程**:
    1.  **多源POI检索**: 系统获取用户输入的实体名称，调用既有的多源POI搜索接口（如 `amap_search`, `baidu_search`），获取所有地图服务商返回的候选POI列表。
    2.  **LLM启发式评估**: 将所有候选POI列表提交给大语言模型（LLM），并要求其基于以下启发式规则进行快速评估：
        *   **尺度失配（Scale Mismatch）**: 候选点的空间尺度是否与查询实体匹配？（例如，查询“历史街区”，返回“武冈市”或“邵阳机场”则为严重失配）。
        *   **类别失配（Category Mismatch）**: 候选点的POI分类是否与查询实体相关？（例如，查询“历史街区”，返回“停车场”、“农贸市场”则为类别失配）。
        *   **名称关联性弱（Weak Name Association）**: 候选点的名称是否可能存在歧义？（例如，查询“穿城河”，返回“穿城河小区”、“穿城河渔馆”，则关联性弱）。
    3.  **决策**:
        *   **若存在高置信度结果**: 如果有任何一个候选POI通过了上述所有评估，LLM可能会认为其“靠谱”，流程可以提前终止，并将该结果推荐给用户。
        *   **若所有结果均不靠谱**: 如果所有候选POI均被判定为低质量，系统则自动进入下一阶段，无需用户干预。

---

#### B.3 第二阶段：知识增强与迭代式探测

当直接搜索失败时，此阶段将扮演“智能研究员”和“侦探”的角色，主动从开放网络中获取知识，并据此进行新一轮的精确打击。

*   **执行流程**:
    1.  **启动网络搜索 (Web Search)**:
        *   系统触发一次针对原始实体全称的后台网络搜索。
        *   **搜索优化**: 优先查找政府公示文件（如保护规划）、地方志、官方文旅介绍、百科词条等高权威性信源。
    2.  **结构化信息提取 (Structured Info Extraction)**:
        *   LLM负责阅读和理解搜索到的非结构化文本内容。
        *   LLM从中提取出一个结构化的**“地理实体情报摘要”**，并对信息进行分类标记，例如：
            *   **目标实体**: `穿城河历史文化街区`
            *   **包含->核心地标**: `[武冈文庙, 龙王庙, 鳌山庙, 牛市桥]`
            *   **包含->内部街道**: `[新街, 回龙街, 鳌山街, 川正街]`
            *   **边界->边界道路**: `[清渠街, 四牌路, 都梁路, 广乐路]`
            *   **特征描述**: `[水系景观, 古建筑群, 五座古桥]`
    3.  **生成候选POI关键词 (Generate Candidate Keywords)**:
        *   基于上述“情报摘要”，LLM生成一个带有**优先级**的新POI搜索关键词列表。
        *   **优先级排序策略**:
            *   **高优先级**: 唯一性强的核心地标（如“武冈文庙”），因为它们最可能被地图收录且不易重名。
            *   **中优先级**: 内部核心街道（如“回龙街”），可能存在重名，需要结合行政区划验证。
            *   **低优先级**: 边界道路，用于定义范围，但通常不代表核心。
    4.  **启动迭代探测循环 (Initiate Probing Loop)**:
        *   系统按照优先级顺序，遍历关键词列表，为每个关键词启动新一轮的POI搜索。
        *   **交叉验证 (Cross-Validation)**: 对每一个返回的POI结果，LLM必须进行严格的**行政区划交叉验证**。例如，搜索“回龙街”，返回的结果必须位于“武冈市”，否则直接丢弃。
        *   **结果质量评估**: LLM评估返回的POI是实体本身（如街道、名胜古迹），还是实体上的次级目标（如“新街上的家具店”）。若是后者，则判定为“不理想”，继续循环。
    5.  **循环终止**:
        *   **成功**: 一旦找到一个高优先级、地理位置一致、POI类别匹配的精确结果（如“武冈文庙”），循环立即终止，该结果被采纳为最终的“最佳定位点”。
        *   **失败**: 若所有候选关键词都已尝试完毕，仍未找到满意结果，流程终止。系统可以向用户报告无法精确定位，或提供一个基于多点计算的“估算中心点”作为次优解。

---

#### B.4 结果呈现与可解释性

向用户交付结果的方式，与结果本身同样重要。

*   **功能目标**: 清晰地向用户展示最终定位结果，并附上简明的推理过程，让用户“知其然，并知其所以然”。

*   **执行流程**:
    1.  **更新UI**: 智能搜索完成后，找到的“最佳定位点”会自动被选为当前校准地址的最终结果，并更新所有相关UI（如右侧的选定结果卡片、左侧的校准地图等）。
    2.  **展示推理过程**:
        *   在结果卡片或一个专门的提示区域，用简洁的自然语言向用户展示本次智能搜索的决策逻辑。
        *   **示例**:
            > **智能解析报告:**
            > 未能直接定位“穿城河历史文化街区”。
            > **网络情报分析发现：** “武冈文庙”是其核心的文物保护单位和重要地标。
            > **最终决策：** 已采纳“武冈文庙”的POI点作为当前地址的精确位置。
    3.  **用户确认**: 用户查看报告后，可以接受此结果，也可以继续使用其他工具进行微调。这个由AI辅助得出的高质量结果，极大地节省了用户手动查找和决策的时间。 