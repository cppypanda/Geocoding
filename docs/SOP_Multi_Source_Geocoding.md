### 多源地理编码标准作业流程 (SOP) - V3.0

**版本: 3.0**
**最后更新日期: 2023-10-27**

#### 1. 核心目标与设计哲学

本文档旨在固化并阐明本项目的多源地理编码算法。此算法是经过长期业务实践验证的最佳方案，旨在以**成本效益最高**的方式，为用户提供**最精确**的地理编码结果。

**核心原则：**
*   **逻辑优先**: 业务逻辑的正确性与健壮性，优先级高于代码结构的绝对"优雅"。
*   **成本控制**: 优先使用成本较低或免费额度较高的服务，并最小化不必要的API调用。
*   **质量保证**: 结果的准确性是最终目标，通过"预处理"、"后处理"等步骤确保数据质量。
*   **务实可行**: 根据不同服务商API的返回特性，采用差异化的、最适合其数据的评估模型。

**任何对地理编码模块的后续修改，都必须以不违背本文档定义的流程为前提。**

---

#### 2. 整体执行架构

*   **地址间并行处理**: 当接收到包含多个地址的批量请求时，系统应为列表中的**每一个地址**启动一个独立的、并行的处理任务。这确保了批量处理的高效率。
*   **服务商间串行处理 (瀑布流)**: 对于**单个地址**的处理，系统严格遵循预设的"瀑布流"顺序，依次调用不同的地图服务商。这确保了逻辑的确定性和成本控制。
*   **服务商并发限制**: 为确保API调用的稳定性和遵守服务商的速率限制，对**每个地图服务商**（高德、百度、天地图等）的API调用都设置了并发控制器。系统保证对任意单个服务商的并发请求量，在任何时候都**不会超过每秒3个**。

---

#### 3. 步骤一：预处理 - 行政区划补全

在进行任何地理编码API调用之前，所有输入的地址字符串都必须经过**行政区划补全程序**。

*   **目标**: 识别并补全地址中缺失的省、市、区/县信息，为后续API查询提供更高质量的输入。
*   **实现**:
    *   **后端内置**: 此补全是地理编码核心流程（`/geocode/process`接口）的一个自动化、强制性的内置步骤。它通过调用统一的地址处理工具函数 `utils.address_processing.complete_address_jionlp` 来实现。
    *   **前端工具复用**: 为了保证用户所见即所得，前端"高级选项"中的"自动补全行政区划"按钮，调用的API（`/jionlp_autocomplete`）也必须使用**同一个** `complete_address_jionlp` 工具函数。这确保了用户手动预览的补全结果与系统后台实际处理的结果完全一致。
*   **产出**:
    1.  一个经过补全、更适合进行API查询的地址字符串（供后续步骤使用）。
    2.  一套结构化的**原始地址**行政区划数据（省、市、区/县、详细地址）。这份数据应被**缓存**起来，供**步骤四的A-类置信度模型**直接使用。

---

#### 4. 步骤二：核心瀑布流决策逻辑

对于单个地址，处理流程严格遵循以下顺序。`CONFIDENCE_THRESHOLD` 是一个在配置文件中定义的置信度阈值（例如 `0.9`）。

1.  **第一顺位：高德地图 (Amap)**
    *   调用 `AmapGeocoder` 处理地址 (详见第5.1节)。
    *   使用 **A-类置信度计算模型** (详见第7.1节) 计算其 `calculated_confidence`。
    *   **如果**置信度 **≥** `CONFIDENCE_THRESHOLD`，则**立即采纳**高德的结果作为"优胜者"，并**直接进入步骤三（后处理）**。
    *   **否则**，将高德的结果存入"候选列表"，流程进入下一顺位。

2.  **第二顺位：天地图 (Tianditu)**
    *   调用 `TiandituGeocoder` 处理地址。
    *   使用 **B-类置信度计算模型** (详见第7.2节) 计算其 `calculated_confidence`。
    *   **如果**置信度 **≥** `CONFIDENCE_THRESHOLD`，则**立即采纳**天地图的结果作为"优胜者"，并**直接进入步骤三（后处理）**。
    *   **否则**，将天地图的结果存入"候选列表"，流程进入下一顺位。

3.  **第三顺位：百度地图 (Baidu)**
    *   调用 `BaiduGeocoder` 处理地址。
    *   使用 **B-类置信度计算模型** (详见第7.2节) 计算其 `calculated_confidence`。
    *   **如果**置信度 **≥** `CONFIDENCE_THRESHOLD`，则**立即采纳**百度的结果作为"优胜者"，并**直接进入步骤三（后处理）**。
    *   **否则**，将百度的结果存入"候选列表"，流程进入最终选择阶段。

4.  **最终选择阶段 (Fallback)**
    *   比较"候选列表"中所有结果的 `calculated_confidence` 分数。
    *   选择并采纳**分数最高**的那个结果作为"优胜者"，进入**步骤三（后处理）**。

---

#### 5. 步骤三：服务商内部处理逻辑

每个 `Geocoder` 类内部，负责执行标准的正向地理编码请求，并根据服务商特性对结果进行预处理。**此阶段不进行任何逆地理编码操作。**

##### 5.1. `AmapGeocoder` 内部逻辑
*   **流程**:
    1.  调用高德地图API进行正向地理编码。API可能会返回一个包含多个候选结果的列表。
    2.  **内部选优**: 对返回列表中的**每一个候选结果**，都调用一次**A-类置信度计算模型**进行评分。
    3.  **返回单体**: 仅将列表中置信度分数**最高**的那个结果，作为 `AmapGeocoder` 的最终产出，返回给主瀑布流。

##### 5.2. `TiandituGeocoder` 内部逻辑
*   **流程**:
    1.  调用天地图API进行正向地理编码。
    2.  将服务商返回的原始结果直接返回给主瀑布流。

##### 5.3. `BaiduGeocoder` 内部逻辑
*   **流程**:
    1.  调用百度地图API进行正向地理编码。在API请求中，**必须**设置 `ret_coordtype=gcj02ll` 参数，以确保返回的坐标系是国测局统一的GCJ-02标准，从而避免任何后续的坐标转换。
    2.  将服务商返回的原始结果直接返回给主瀑布流。

---

#### 6. 步骤四：后处理 - 差异化逆地理编码与结果增强

此步骤只对瀑布流中选出的唯一"优胜者"执行。

*   **目标**: 获取最详尽、最权威的地址描述，用于最终的表格展示。
*   **适用范围**: 此步骤仅对**百度地图**或**天地图**的"优胜"结果是**必须**的，因为它们的正向编码结果不包含丰富的地址组件。对于**高德地图**，此步骤为**可选或跳过**，因为其正向编码结果已足够丰富。
*   **流程**:
    1.  获取"优胜者"结果中的坐标。
    2.  调用"优胜者"**自己**的逆地理编码API。
    3.  使用逆地理编码返回的结果来更新或替换"优胜者"原有的地址信息。

---

#### 7. 置信度计算标准 (差异化模型)

> **重要说明**: 本章节描述的置信度算法专门用于**多源地理编码**功能，与**POI搜索功能**使用的多维度置信度算法是完全独立的两套算法。POI搜索功能采用更复杂的多维度评估和包含关系增强算法，详见《POI搜索功能规格书》。

##### 7.1. A-类模型: 基于文本相似度与地名后缀移除的增强型计算
*   **适用对象**: 高德地图 (Amap)。
*   **算法详情**: 请参考《[置信度算法规格书](SOP_Confidence_Algorithm.md)》中的"地理编码模式算法"章节。
*   **核心特点**: 
    *   行政区划硬性过滤确保地理一致性
    *   地址后缀移除提升匹配精度  
    *   包含关系增强算法处理部分匹配情况
    *   基于`Levenshtein.ratio`的文本相似度计算
*   **技术实现**: 调用 `calculate_unified_confidence(mode='geocoding')` 函数

##### 7.2. B-类模型: 基于原生指标的直接映射
*   **适用对象**: 百度地图 (Baidu)、天地图 (Tianditu)。
*   **计算步骤**:
    *   **对于百度地图**:
        1.  获取其返回的 `confidence` 和 `comprehension` 两个字段的值。
        2.  计算公式为：`calculated_confidence = ((confidence + comprehension) / 2) / 100.0`。
    *   **对于天地图**:
        1.  获取其返回的 `score` 字段的值。
        2.  计算公式为: `calculated_confidence = score / 100.0` (假设score为0-100制，若非如此则需调整)。

---

#### 附录A：API响应实例与特性分析

为了设计出健壮的标准化流程，我们必须了解每个地理编码服务API响应的具体结构和数据特性。以下示例基于对一个相对模糊的地址（主干道）的查询，该查询旨在演示多候选结果的处理。

#### A.1 高德地图 (Amap)

- **调用地址**: `成都市高新区天府大道中段`
- **特点**: 返回多个候选结果（本例中6个），但**不提供**原生置信度指标。需要通过A-类模型计算置信度。响应中包含详细的地址组件和地理层级信息。
- **原始响应**:
```json
{
  "status": "1",
  "info": "OK", 
  "infocode": "10000",
  "count": "6",
  "geocodes": [
    {
      "formatted_address": "四川省成都市双流区成都高新区天府大道中段",
      "country": "中国",
      "province": "四川省",
      "citycode": "028", 
      "city": "成都市",
      "district": "双流区",
      "township": [],
      "neighborhood": {
        "name": [],
        "type": []
      },
      "building": {
        "name": [],
        "type": []
      },
      "adcode": "510116",
      "street": "天府大道中段",
      "number": [],
      "location": "104.069196,30.550141",
      "level": "道路"
    },
    {
      "formatted_address": "四川省成都市武侯区成都市高新区天华路",
      "country": "中国",
      "province": "四川省",
      "citycode": "028",
      "city": "成都市", 
      "district": "武侯区",
      "adcode": "510107",
      "street": "天华路",
      "location": "104.071898,30.549384",
      "level": "道路"
    }
  ]
}
```

**关键观察**:
1. **多候选结果**: 高德返回6个候选，其中前3个完全相同（可能是API的重复数据）
2. **地址变异**: 用户搜索"天府大道中段"，但也返回了"天华路"的结果
3. **行政区划差异**: 同样的查询返回了"双流区"和"武侯区"两个不同的行政区
4. **无原生置信度**: 高德不提供confidence字段，必须依赖A-类模型计算
5. **详细组件**: 提供完整的地址组件分解，便于后续处理

#### A.2 百度地图 (Baidu)

- **调用地址**: `成都市高新区天府大道中段`
- **特点**: 总是返回单个结果。响应中包含`confidence`（置信度）和`comprehension`（地址理解程度）两个原生指标，为结果可靠性评估提供了直接依据。
- **原始响应**:
```json
{
    "status": 0,
    "result": {
        "location": {
            "lng": 104.07232947216939,
            "lat": 30.59928411358897
        },
        "precise": 0,
        "confidence": 50,
        "comprehension": 57,
        "level": "工业园区"
    }
}
```

#### A.3 天地图 (Tianditu)

- **调用地址**: `成都市高新区天府大道中段`
- **特点**: 总是返回单个结果。响应结构相对简单，直接在`location`对象中提供经纬度和`score`（匹配得分）。它不返回结构化的地址组件（如省市区），这意味着如果需要这些信息，必须进行后续的反向地理编码。
- **原始响应**:
```json
{
    "msg": "ok",
    "location": {
        "score": 100,
        "level": "兴趣点",
        "lon": "104.069081",
        "lat": "30.539395",
        "keyWord": "成都市高新区天府大道中段"
    },
    "searchVersion": "7.3.0V",
    "status": "0"
}
``` 