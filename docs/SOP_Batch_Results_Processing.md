### 批量结果总览与导出标准作业流程 (SOP) - V1.0

**版本: 1.0**
**最后更新日期: 2023-11-15**

#### 1. 核心目标

本文档旨在详细说明"批量地理编码"完成之后，用户在**结果总览与导出**阶段可用的所有功能。此阶段的核心是为用户提供一个清晰、高效的界面，用于审查、管理和导出批量地理编码的最终成果。

**核心原则：**
*   **所见即所得**: 用户在界面上看到的结果，就是最终导出的结果。
*   **批量优先**: 提供强大的批量工具（如智能选择、导出）以提升大数据量处理效率。
*   **流程衔接**: 本SOP是"多源地理编码SOP"的直接下游，并为"单点校准SOP"提供入口和数据基础。

---

#### 2. 功能模块一：结果总览与导出

这是用户完成批量编码后看到的第一个界面，核心是结果数据表格。

*   **功能目标**: 集中展示所有地址的编码结果，提供快速筛选、排序和导出功能。

*   **界面元素**:
    *   结果数据表格 (`#cascadeResultsBody`)。
    *   结果总览地图 (`#overviewMap`)。
    *   导出按钮 (`#exportCsvBtn`, `#exportXlsxBtn`, `#exportShpBtn`, `#exportKmlBtn`)。
    *   辅助操作按钮 (`#clearAllResultsBtn`, `#showAllOnOverviewMapBtn`)。
    *   智能选择全部按钮 (`#autoSelectAllBtn`)。
    *   名录名称输入提示。

*   **执行流程与功能**:
    1.  **动态结果展示与交互**:
        *   **核心定位**: 结果表格是一个**动态数据视图**，而非一次性静态报告。它始终展示当前最新状态的结果。
        *   **数据来源**:
            *   **初始填充**: 由"普通地理编码"或"一键智能编码"的"优胜者"结果进行初始填充。
            *   **动态更新**: 表格中的任何一行数据，都可以被后续的"单点校准"操作（详见《单点校准SOP》）所覆盖和更新。表格会实时反映这些手动修正。
            *   **行政区划数据填充**:
                *   **数据来源**: 表格中的"省"、"市"、"区县"列的数据**优先**来自于批量处理第一步的"地址预处理与补全"阶段。系统使用 `jionlp` 库对原始地址进行解析，提取出结构化的行政区划信息。
                *   **实现机制**: 在后端 `geocoding.py` 中，预处理阶段解析出的省市区信息会被缓存。在整合最终的地理编码结果时，这些缓存的信息会**优先填充**到对应的字段中。只有当预处理未能解析出某个字段时，才会使用地理编码API（如高德）返回的信息作为备选。
                *   **目标**: 此机制确保了行政区划信息的**高度准确性和一致性**，解决了不同地图API对同一行政区划名称（如"北京市"与"北京"）表述不一的问题。
        *   **地图联动**:
            *   点击表格中的任意一行，总览地图的视窗会自动移动并缩放，以被点击行对应的坐标点为中心。
            *   点击地图右上角的"显示全部"按钮，地图则会恢复到能容纳所有点的全局视野。
        *   **技术实现**: 表格由 `results-table.js` 的 `render` 函数渲染。地图标记更新由 `map.js` 的 `updateResultsOverviewMapMarkers` 实现。表格行点击联动地图的交互逻辑需要新增或在 `results-table.js` 的行点击事件中完善。

    2.  **辅助操作**:
        *   **显示全部 (`#showAllOnOverviewMapBtn`)**: 调整总览地图的缩放级别和中心点，确保所有已选定结果的标记都在地图可视范围内。

    3.  **结果导出 (`handleDownloadData`)**:
        *   用户点击"导出CSV"、"导出Excel"、"导出SHP"或"导出KML"按钮。
        *   **名录名称处理**:
            *   **命名时机**: 在执行导出前，系统会确保当前任务有一个"名录名称"。
            *   **命名机制**: 界面会弹出一个文本框，其中包含一个默认的或已存在的名录名称，用户可以**确认或修改**此名称。
            *   **名称同步**: 用户在此处确认的名称，将被视为此批次任务的正式名称，用于生成文件名，并可被后续的数据保存或项目管理功能沿用。
        *   **未来规划 (LLM支持)**:
            *   为了提升自动化程度，规划在更高层次的任务管理模块中，利用LLM分析用户输入的地址，自动生成一个富有语义的默认"名录名称"（例如，从多个"XX市XX区星巴克"地址中总结出"XX市星巴克门店"）。
            *   这个由LLM生成的名称，将作为默认值自动填充到上述的命名文本框中。
        *   系统将表格中**当前所有已选定**的结果打包，调用后端API (`/export_data`)生成相应格式的文件供用户下载。
        *   **技术实现**: 前端逻辑位于 `results-table.js` 的 `handleDownloadData` 函数，后端由 `app/routes/main.py` 的 `/export_data` 接口处理，该接口具备生成包括Shapefile、KML在内的多种格式的能力。

    4. **流程衔接与未来规划**:
        *   **低置信度结果智能引导 (未来规划)**:
            *   **功能目标**: 在编码流程结束后，主动引导用户处理潜在的低质量数据，提升最终成果的准确性。
            *   **触发逻辑**: 当批量编码完成后，若结果中存在任何一条置信度低于`90%`的记录。
            *   **交互形式**: 系统将自动弹出一个对话框，提示："xx条结果置信度小于90%，建议进行AI自动查询或逐一校准"。
            *   **操作选项**: 对话框将提供三个按钮，例如："AI自动优化"（触发`一键智能搜索`高级功能）、"手动逐条校准"（触发`衔接到单点校准`功能）、"稍后处理"（关闭对话框）。
        *   **衔接到单点校准**:
            *   **入口**: "逐条查看与校准"按钮 (`#viewDetailsSequentiallyBtn`) 是从当前的总览视图，切换到精细化校准视图的**唯一入口**。
            *   **功能**: 点击后，系统将切换到"单点校准面板"，并将当前结果列表中的第一条或上一次选中的条目加载到面板中进行详细处理。其详细功能遵循《单点校准标准作业流程 (SOP)》文档。
        *   **一键智能搜索 (未来规划)**:
            *   **战略定位**: 此功能将取代被弃用的"一键智能选择"，成为处理低置信度地址的核心高级功能。
            *   **功能目标**: 不再局限于从已有的低质量结果中"劣中选优"，而是通过多阶段的智能搜索，主动为地址寻找更精确的定位。
            *   **大致流程**: 其工作流将更为复杂，可能包含：1. 基于地址关键词进行初次POI搜索；2. 利用LLM从POI结果中智能筛选最佳候选；3. 若候选依然不佳，则启动网络爬虫或调用联网大模型进行网络情报搜索，形成新的地点建议；4. 将新建议用于新一轮的POI搜索，形成闭环。
            *   **当前状态**: 此功能为**未来规划**。前端界面已在"更多操作"菜单中为此功能预留了按钮 (`#smartSearchAllBtn`)。其完整SOP将在专门的文档中定义。
        *   **保存结果到账户 (未来规划)**:
            *   **功能目标**: 允许用户将当前批次的地理编码结果（包括所有手动校准的修正）作为一个完整的"名录"保存到自己的账户中，以便未来随时查看、再次编辑或分享。
            *   **当前状态**: 此功能为**未来规划**。当前版本的前端界面已为此功能预留了"保存结果到账户"按钮 (`#saveResultsBtn`)，但后端存储和前端调用逻辑**尚未实现**。

--- 