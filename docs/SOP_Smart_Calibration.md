# SOP: 智能校准功能 (精确界面模拟版)

**版本**: 2.0
**日期**: 2024-06-14

## 1. 功能概述

“智能校准”功能旨在自动化处理批量地理编码结果中可信度较低的地址。它通过**纯粹模拟用户在界面上的真实点击、等待、和观察操作**，来为可信度低于90%的地址找到一个更优的地理编码结果，从而提高数据准确率。

## 2. 触发条件

- 用户在批量地理编码结果页面点击 **“<i class="bi bi-robot"></i> 智能校准”** 按钮。

## 3. 工作流程详解

### 3.1. 初始化阶段

1.  **启动**: 功能被触发。
2.  **筛选目标**: 系统会遍历当前结果列表中的所有地址，并筛选出所有“可信度”低于90%的地址记录。

### 3.2. 单条地址校准循环

对于每一个筛选出的低可信度地址，执行以下步骤：

#### 3.2.1. 准备阶段

1.  **操作**: 模拟点击该地址所在行的 **“<i class="bi bi-card-list"></i>”** (逐条查看)按钮。
2.  **等待依据**: 等待“逐条校准”面板 (`#detailedReviewSection`) 完全可见。
3.  **操作**: 模拟点击 **“地址查找工具”** 按钮 (`#showAddressSearchToolsBtn`)。
4.  **等待依据**: 等待“地址查找工具”面板 (`#addressSearchTools`) 完全展开。
5.  **前置操作**: **记录下“当前选定结果”卡片中地址的初始文本内容** (`#selectedFormattedAddress`的文本)。这将作为后续判断是否“更新成功”的基准。

#### 3.2.2. POI 搜索引擎轮询

- **核心成功依据**: 在每一步搜索后，**检查“当前选定结果”卡片 (`#selectedResultDetailCard`) 中显示的地址文本，是否与在“准备阶段”记录的初始文本内容发生了变化**。一旦发生变化，说明有了新的选点，此地址校准成功，立即跳到下一个待校准地址。
- **智能选点机制**: **等待POI搜索或关键词搜索过程中的加载动画 (`#mapSearchSpinner` 等) 彻底消失**。由于加载动画现在会持续到选点完成，所以一旦动画消失，即可认为该步骤已结束（无论成功或失败），然后立即检查 **“核心成功依据”**。如果不满足，则判定此步骤失败，进入下一步操作。

1.  **首次尝试：高德地图**
    - **操作**: 选中POI搜索源下拉框 (`#map-search-source`)中的“高德地图”，然后模拟点击 **“<i class="bi bi-search"></i> 搜索”** 按钮 (`#mapSearchBtn`)。
    - **等待并判断**: 执行上述的 **“核心等待依据”** 和 **“核心成功依据”** 检查。不满足则进入下一步。

2.  **二次尝试：天地图**
    - **操作**: 选中“天地图”，再次点击 **“搜索”** 按钮。
    - **等待并判断**: 执行 **“核心等待依据”** 和 **“核心成功依据”** 检查。不满足则进入下一步。

3.  **三次尝试：百度地图**
    - **操作**: 选中“百度地图”，再次点击 **“搜索”** 按钮。
    - **等待并判断**: 执行 **“核心等待依据”** 和 **“核心成功依据”** 检查。不满足则进入下一步。

#### 3.2.3. 关键词建议与搜索

- **条件**: 仅在上述所有地图搜索都未能成功更新“当前选定结果”卡片时执行。

1.  **获取网络信息**:
    - **操作**: 模拟点击 **“获取网络信息”** 按钮 (`#step1SearchBtn`)。
    - **等待依据**: 等待其旁边的加载动画 (`#step1Spinner`) 消失 (超时2分钟)。

2.  **生成关键词**:
    - **操作**: 模拟点击 **“生成关键词建议”** 按钮 (`#step3SuggestBtn`)。
    - **等待依据**: 等待其旁边的加载动画 (`#step3Spinner`) 消失 (超时1分钟)。

3.  **关键词循环搜索**:
    - **操作**: 依次模拟点击每一个出现的蓝色关键词按钮 (`.use-keyword-btn`)。
    - **等待并判断**: 每点击一个关键词，都会触发一次POI搜索。因此，每次点击后都执行 **3.2.2节中定义的“核心等待依据”和“核心成功依据”**。
      - **如果成功**，则此地址校准成功，**立即停止**点击其他关键词，直接跳到下一个待校准地址。
      - **如果不成功**，则继续点击下一个关键词。

#### 3.2.4. 最终失败

- 如果所有关键词都尝试完毕，“当前选定结果”卡片的内容仍未发生变化，则此地址最终判定为校准失败。

### 3.3. 完成阶段

1.  **循环结束**: 当所有待处理的地址都经过了上述完整的校准流程后，整个功能运行结束。
2.  **总结报告**: 系统会弹出一个最终的总结信息，例如：“智能校准完成。成功: X, 失败: Y”。
